<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reader</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="./css/reset.css">
    <style>
        @font-face {
        font-family: 'icomoon';
        src:  url('fonts/icomoon.eot?hv7f1q');
        src:  url('fonts/icomoon.eot?hv7f1q#iefix') format('embedded-opentype'),
            url('fonts/icomoon.ttf?hv7f1q') format('truetype'),
            url('fonts/icomoon.woff?hv7f1q') format('woff'),
            url('fonts/icomoon.svg?hv7f1q#icomoon') format('svg');
        font-weight: normal;
        font-style: normal;
        }

        [class^="iconClass-"], [class*=" iconClass-"] {
        /* use !important to prevent issues with browser extensions that change fonts */
        font-family: 'icomoon' !important;
        speak: none;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-transform: none;
        line-height: 1;

        /* Better Font Rendering =========== */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        }

        .iconClass-moon-o:before {
        content: "\e904";
        }
        .iconClass-list2:before {
        content: "\e905";
        }
        .iconClass-sun:before {
        content: "\e901";
        }
        .iconClass-circle-left:before {
        content: "\e902";
        }
        .iconClass-text-color:before {
        content: "\e903";
        }


       html{
           width:100%;
           height: 100%;
           overflow-x: hidden;
       }
       body{
           text-align:left;
           width:100%;
           overflow: hidden;
           background: #e9dfc7;
       }
       .m-fiction-container{
           font-size: 14px;
           color:#555;
           line-height: 31px;
           padding:15px
       }
       .m-fiction-container h4{
           font-size: 20px;
           color:#736357;
           border-bottom:1px solid #736357;
           letter-space:2px;
           margin: 0 0 1em 0;
       }
       .u-tab{
           height:34px;
           line-height:34px;
           margin:10px auto;
           background:#000000;
           opacity:0.9;
           border-radius:8px;
           border:solid 1px #858382;
           font-size: 12px;
       }
       .u-tab li{
          float:left;
           text-align: center;
           color:#fff;
           width:50%;
           border-right:solid 1px #fff;
           box-sizing:border-box;
       }
       .u-tab li:nth-child(2){
           border-right:none;
       }
       .m-button-bar{
           width:70%;
           max-width:800px;
           margin:0 auto;
           padding:5px;
       }
       .nav-bar{
           background: #000;
           position: fixed;
           top: 0;
           z-index: 999;
           height: 50px;
           width: 100%;
           line-height: 50px;
           padding-left: 10px;
       }
       .nav-bar i,.nav-bar .nav-title{
           color: #d5d5d6;
       }
       .nav-bar .nav-title{
           display: inline-block;
           position: relative;
           margin-left: 7px;
           top: -5px;
           line-height: 50px;
           font-size: 14px;
       }
       .nav-bar i{
           font-size: 24px;
           line-height: 50px;
       }
       .foot-nav{
            width:100%;
            height:70px;
            background:none;
            position:fixed;
            margin: 0 auto;
            text-align:center;
            opacity:1;
            bottom:0px;
            z-index:10004;
            color: white;
        }
        .foot-bar{
            background: #000;
            opacity: 0.9;
        }
        .foot-bar-word{
            display: flex;
            -webkit-flex-direction: row;
            -moz-flex-direction: row;
            -ms-flex-direction: row;
            -o-flex-direction: row;
            flex-direction: row;

        }
        .foot-bar-word .item{
            -webkit-flex: 1 1;
            -moz-flex: 1 1;
            -ms-flex: 1 1;
            -o-flex: 1 1;
            flex: 1 1;
        }
        .item .item-wrapper{
            padding-top: 15px;
        }
        .item .icon-text{
            font-size: 10px;
        }
        .foot-pannel-bk{
            position: fixed;
            width: 100%;
            height: 125px;
            bottom: 70px;
            background: #000;
            opacity: 0.9;
            z-index: 10000;
        }
        .foot-pannel{
            position:fixed;
            width:100%;
            height:125px;
            bottom:70px;
            background:none;
            color:#fff;
            z-index:10001;
        }
        .child-pannel{
            padding: 5px 10px;
            margin: 15px
        }
        .child-pannel span{
            display: inline-block;
            padding-right: 20px;
            padding-left:10px;
        }
        .font-change{
            background: none;
            border: 1px solid #8c8c8c;
            border-radius: 16px;
            padding: 5px 40px;
            color: #fff;
            margin-right: 10px;
        }
        .icon-color-bar{
            position: relative;
            width: 30px;
            height: 30px;
            border-radius: 15px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .icon-color-current{
            padding: 2px;
            border: 1px solid #ff7800;
            border-radius: 16px;
        }
        .color1{
            background:#f7eee5;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .color2{
            background:#e9dfc7;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .color3{
            background:#a4a4a4;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .color4{
            background:#cdefce;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .color5{
            background:#283548;
            -webkit-background-clip: content-box;
            -moz-background-clip: content-box;
            background-clip: content-box;
        }
        .article-action-mid{
            z-index: 10002;
            width:100%;
            position: fixed;
            height: 40%;
            top:30%;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="m-article-action">
            <div class="article-action-mid" id="action_mid"></div>
        </div>

        <div id="nav_bar" class="nav-bar" style="display:none">
            <i class="iconClass-circle-left"></i>
            <div class="nav-title">返回书架</div>
        </div>

        <div id="foot-bar" class="foot-bar foot-nav" style="display:none"></div>
        <div id="foot-bar-word" class="foot-bar-word foot-nav" style="display:none">
            <div class="item m-catelog-bar">
                <div class="item-wrapper">
                    <i class="iconClass-list2"></i>
                    <div class="icon-text">
                        目录
                    </div>
                </div>
            </div>
            <div class="item m-font-bar">
                <div class="item-wrapper">
                    <i class="iconClass-text-color"></i>
                    <div class="icon-text">
                        字体
                    </div>
                </div>
            </div>
            <div class="item m-day-change-bar">
                <div class="item-wrapper">
                    <div class="night-day">
                         <i class="iconClass-moon-o"></i>
                        <div class="icon-text">
                            夜间
                        </div>
                    </div>
                    <div class="light-day" style="display:none">
                        <i class="iconClass-sun"></i>
                        <div class="icon-text">
                            夜间
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="foot-pannel-bk pannel-control" style="display:none"></div>
        <div class="foot-pannel pannel-control" style="display:none">
            <div class="child-pannel" id="font-pannel">
                <span class="font-word">字号</span>
                <button class="font-change" id="big_font">大</button>
                <button class="font-change" id="small_font">小</button>
            </div>
            <div class="child-pannel color-pannel">
                <span class="color-change">颜色</span>
                <div class="icon-color-bar icon-color-current  color1" id="color1">
                    <div class="color1-bk"></div>
                </div>
                <div class="icon-color-bar color2" id="color2">
                    <div class="color2-bk"></div>
                </div>
                <div class="icon-color-bar color3" id="color3">
                    <div class="color3-bk"></div>
                </div>
                <div class="icon-color-bar color4" id="color4">
                    <div class="color4-bk"></div>
                </div>
                <div class="icon-color-bar color5" id="color5">
                    <div class="color5-bk"></div>
                </div>
            </div>
        </div>
        <div id="fiction_chapter_title"></div>
        <div id="fiction_container" class="m-fiction-container">
            <div id="fiction_word">

            </div>
        </div>
        <div id="change_page" class="m-button-bar">
            <ul class="u-tab">
                <li id="prev_page">上一页</li>
                <li id="next_page">下一页</li>
            </ul>
        </div>
    </div>
</body>
<script src="lib/zepto.min.js"></script>
<script>
    window.jQuery = $;
</script>
<script src="js/jquery.base64.js"></script>
<script src="js/jquery.jsonp.js"></script>

<script>
    (function(){
        var Util = (function(){
            var prefix = 'fiction_reader_';
            var storageGetter = function(key){
                return localStorage.getItem(prefix+key);
            }
            var storageSetter = function(key,value){
                return localStorage.setItem(prefix+key,value)
            }

            var getJSONP = function(url,callbackFun){
                $.jsonp({
                    url:url,
                    cache:true,
                    callback:'duokan_fiction_chapter',
                    success:function(json){
                        var decodeJson = $.base64.decode(json);
                        console.log(json);
                        console.log(decodeJson);
                        callbackFun(decodeJson)
                    }
                })
            }

            var addHandler = function(element,type,handler){
                if(element.addEventListener){
                    element.addEventListener(type,handler,false);
                }else if(element.attachEvent){
                    element.attachEvent('on'+type,handler);
                }else{
                    element['on'+type] = handler;
                }
            };

            var getEvent = function(event){
                return event?evnet:window.event;
            }
            var getTarget = function(event){
                return event.target || event.srcElement;
            }
            var changeBkColor = function(BkColor){
                initBkColor = BkColor;
                Dom.fiction_area.css('background-color',initBkColor)
                Util.storageSetter('background-color',initBkColor);
            }
            var changeBkClass = function(target_id){
                Dom.color1_bk.removeClass('icon-color-current');
                Dom.color2_bk.removeClass('icon-color-current');
                Dom.color3_bk.removeClass('icon-color-current');
                Dom.color4_bk.removeClass('icon-color-current');
                Dom.color5_bk.removeClass('icon-color-current');

                $('.'+target_id+'-bk').addClass('icon-color-current');
            }

            return {
                getJSONP:getJSONP,
                addHandler:addHandler,
                getTarget:getTarget,
                getEvent:getEvent,
                changeBkColor:changeBkColor,
                changeBkClass:changeBkClass,
                storageSetter:storageSetter,
                storageGetter:storageGetter
            }
        })();

        var Dom = {
            top_nav:$('#nav_bar'),
            bottom_nav:$('.foot-nav'),
            font_button:$('.m-font-bar'),
            pannel_control:$('.pannel-control'),
            night_day:$('.night-day'),
            light_dat:$('light-day'),
            fiction_area:$('#fiction-container'),
            fiction_word:$('#fiction_word'),
            color1_bk:$('.color1_bk'),
            color2_bk:$('.color2_bk'),
            color3_bk:$('.color3_bk'),
            color4_bk:$('.color4_bk'),
            color5_bk:$('.color5_bk'),
        };

        var readerModel;
        var readerBaseFrame;

        var Win = $(window);
        var Doc = $(document);
        var initFontSize = Util.storageGetter('font-zie');
        initFontSize = parseInt(initFontSize);
        if(!initFontSize){
            initFontSize = 14;
        }
        Dom.fiction_area.css('font-size',initFontSize);

        var initBkColor = Util.storageGetter('background-color');
        if(!initBkColor){
            initBkColor = '#f7eee5';
        }
        Dom.fiction_area.css('background-color',initBkColor);

        var Chapter_length;
        var Chapter_id;

        function main(){
            EventHandler();
            readerModel = ReaderModel();
            readerBaseFrame = ReaderBaseFrame(Dom.fiction_word);

            readerModel.init(function(data){
                readerBaseFrame(data);
            })
        }
        
        function ReaderBaseFrame(container){
            function parseChapterData(data){
                var jsonObj = JSON.parse(data);
                var html = '<h4>' + jsonObj.t + '</h4>';
                for(var i = 0;i < jsonObj.p.length; i++){
                    html += '<p>' + jsonObj.p[i]+ '</p>';
                
                }
                return html;

            }
            return function(data){
                container.html(parseChapterData(data))
            }
        }

        function ReaderModel(){
            var init = function(callbackFun){
                getFictionInfo(function(data){
                    getSingleChapterInfo(data,callbackFun);
                });
            }

            var getFictionInfo = function(callback){
                // debugger;
                $.get('data/chapter.json',function(data){

                    console.log(data)

                    Chapter_length = data.chapters.length;

                    if(Util.storageGetter('chapter_id') == null){
                        Chapter_id = parseInt(data.chapters[0].chapter_id + 1);
                    }else{
                        Chapter_id = parseInt(Util.storageGetter('chapter_id'))
                    }

                    callback && callback(Chapter_id)
                })
            }

            var getSingleChapterInfo = function(chapter_id,callbackFun){
                // debugger;
                $.get('data/data'+chapter_id + '.json',function(data){
                    var url = data.jsonp;
                    Util.getJSONP(url,callbackFun);
                },'json');
            }

            var gotoChapter = function(){
                getSingleChapterInfo(Chapter_id,function(data){
                    readerBaseFrame(data);
                })
            }

            var getPreChapter = function(){
                if(Chapter_id <= 1){
                    return;
                }
                Chapter_id -= 1;
                Util.storageSetter('chapter_id',Chapter_id);
                gotoChapter();
                $(window).scrollTop(0);
            }

            var getNextChapter = function(){
                if(Chapter_id >= 4){
                    return;
                }
                Chapter_id += 1;

                Util.storageSetter('chapter_id',Chapter_id);
                gotoChapter();
                $(window).scrollTop(0);
            }

            return {
                init:init,
                gotoChapter:gotoChapter,
                getPreChapter:getPreChapter,
                getNextChapter:getNextChapter,
                getFictionInfo:getFictionInfo,
                getSingleChapterInfo:getSingleChapterInfo
            }
        }

        function EventHandler(){

        }

        main();
    })()

</script>
</html> 